{% extends "base.html" %}
{% load humanize %}
{% load static %}

{% block title %}Order #{{ order.id }} - PoshPearl{% endblock %}
{% block body_class %}pp-light pp-account{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{% static 'assets/css/light-pages.css' %}?v=20260207">
<link rel="stylesheet" href="{% static 'assets/css/account.css' %}?v=20260207">
{% endblock %}

{% block content %}
<section class="section">
    <div class="container">
        <!-- Account Layout -->
        <div class="grid" style="grid-template-columns: 280px 1fr; gap: var(--space-8);">
            <!-- Sidebar -->
            <aside class="pp-card stack" style="height: fit-content;">
                <div class="flex"
                    style="align-items: center; gap: var(--space-4); padding-bottom: var(--space-4); border-bottom: 1px solid var(--color-border);">
                    <div
                        style="width: 48px; height: 48px; background: var(--color-primary); border-radius: var(--radius-full); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: var(--text-xl);">
                        {{ user.first_name|default:user.username|first|upper }}
                    </div>
                    <div class="stack" style="gap: 0;">
                        <strong style="font-size: var(--text-lg);">Hi, {{ user.first_name|default:user.username
                            }}</strong>
                        <span class="text-muted" style="font-size: var(--text-sm);">{{ user.email }}</span>
                    </div>
                </div>

                <nav class="stack" style="gap: var(--space-1);">
                    <a href="{% url 'dashboard' %}" class="flex"
                        style="align-items: center; gap: var(--space-3); padding: var(--space-2) var(--space-3); border-radius: var(--radius-md); color: var(--color-text-muted); transition: all var(--transition-base);">
                        <i class="fa-solid fa-house" style="width: 20px;"></i>
                        <span>Dashboard</span>
                    </a>
                    <a href="{% url 'user_orders' %}" class="flex"
                        style="align-items: center; gap: var(--space-3); padding: var(--space-2) var(--space-3); border-radius: var(--radius-md); background: var(--color-surface); color: var(--color-primary); font-weight: 500;">
                        <i class="fa-solid fa-receipt" style="width: 20px;"></i>
                        <span>Orders</span>
                    </a>
                    <a href="{% url 'wishlist' %}" class="flex"
                        style="align-items: center; gap: var(--space-3); padding: var(--space-2) var(--space-3); border-radius: var(--radius-md); color: var(--color-text-muted); transition: all var(--transition-base);">
                        <i class="fa-solid fa-heart" style="width: 20px;"></i>
                        <span>Wishlist</span>
                    </a>
                    <a href="{% url 'track_order' %}" class="flex"
                        style="align-items: center; gap: var(--space-3); padding: var(--space-2) var(--space-3); border-radius: var(--radius-md); color: var(--color-text-muted); transition: all var(--transition-base);">
                        <i class="fa-solid fa-truck" style="width: 20px;"></i>
                        <span>Track order</span>
                    </a>
                </nav>
            </aside>

            <!-- Main Content -->
            <main class="stack" style="gap: var(--space-6);">
                <!-- Header -->
                <div class="stack" style="gap: var(--space-2);">
                    <p class="pp-pill" style="width: fit-content;">
                        <i class="fa-solid fa-receipt"></i> Order detail
                    </p>
                    <h1 class="pp-section-title">Order #{{ order.id }}</h1>
                    <p class="text-muted">Placed on {{ order.created_at|date:"F d, Y - g:i A" }}</p>
                </div>

                <!-- Status & Total Cards -->
                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: var(--space-4);">
                    <div class="pp-card stack">
                        <h3>Status</h3>
                        <div class="flex" style="align-items: center; gap: var(--space-2);">
                            <span class="pp-pill" style="background: 
                                {% if order.status == 'delivered' %}var(--color-success)
                                {% elif order.status == 'cancelled' %}var(--color-danger)
                                {% elif order.status == 'paid' %}var(--color-accent)
                                {% else %}var(--color-text-muted){% endif %}; 
                                color: white; font-size: var(--text-base);">
                                {{ order.get_status_display }}
                            </span>
                        </div>
                        <div class="flex" style="justify-content: space-between; margin-top: var(--space-2);">
                            <span class="text-muted">Payment:</span>
                            <span class="pp-pill" style="background: 
                                {% if order.payment_status == 'paid' %}var(--color-success)
                                {% elif order.payment_status == 'failed' %}var(--color-danger)
                                {% else %}var(--color-accent){% endif %}; 
                                color: white;">
                                {{ order.get_payment_status_display }}
                            </span>
                        </div>
                    </div>

                    <div class="pp-card stack">
                        <h3>Total</h3>
                        <div style="font-size: var(--text-3xl); font-weight: 700; color: var(--color-primary);">
                            {{ order.currency }} {{ order.amount|intcomma }}
                        </div>
                        <div class="flex" style="justify-content: space-between; margin-top: var(--space-2);">
                            <span class="text-muted">Subtotal:</span>
                            <strong>{{ order.currency }} {{ order.subtotal|intcomma }}</strong>
                        </div>
                    </div>
                </div>

                <!-- Order Items -->
                <div class="pp-card stack">
                    <h2>Items</h2>
                    <div class="stack" style="gap: var(--space-3);">
                        {% for item in order.items.all %}
                        <div class="grid"
                            style="grid-template-columns: 2fr 1fr auto; align-items: center; gap: var(--space-4); padding: var(--space-3); border: 1px solid var(--color-border); border-radius: var(--radius-md);">
                            <div class="stack" style="gap: var(--space-1);">
                                <strong>{{ item.product.name|default:"Product" }}</strong>
                                <span class="text-muted" style="font-size: var(--text-sm);">{{ item.quantity }} × {{
                                    item.currency }} {{ item.unit_price|intcomma }}</span>
                            </div>
                            <div style="text-align: right;">
                                <strong>{{ item.currency }} {{ item.line_total|intcomma }}</strong>
                            </div>
                            <div>
                                {% if item.product %}
                                <a href="{% url 'product_detail_products' item.product.slug %}"
                                    class="pp-btn pp-btn--ghost" style="padding: var(--space-1) var(--space-2);">
                                    <i class="fa-solid fa-arrow-right"></i>
                                    <span class="sr-only">View product</span>
                                </a>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>

                <!-- Delivery & Payment Info -->
                <div class="grid" style="grid-template-columns: 1fr 1fr; gap: var(--space-4);">
                    <div class="pp-card stack">
                        <h3>Delivery address</h3>
                        <div class="stack" style="gap: var(--space-1);">
                            <p class="text-muted" style="white-space: pre-line; margin: 0;">{{ order.address }}</p>
                            <p class="text-muted" style="margin: 0;"><strong>Phone:</strong> {{ order.phone }}</p>
                            {% if order.notes %}
                            <p class="text-muted" style="margin-top: var(--space-2);"><strong>Notes:</strong> {{
                                order.notes }}</p>
                            {% endif %}
                        </div>
                    </div>

                    <div class="pp-card stack">
                        <h3>Payment info</h3>
                        <div class="stack" style="gap: var(--space-2);">
                            {% if order.payment_reference %}
                            <div>
                                <span class="text-muted">Reference:</span>
                                <code
                                    style="display: block; margin-top: var(--space-1); padding: var(--space-2); background: var(--color-surface); border-radius: var(--radius-sm); font-size: var(--text-sm);">
                                    {{ order.payment_reference }}
                                </code>
                            </div>
                            {% endif %}

                            {% if order.paid_at %}
                            <div class="flex" style="justify-content: space-between;">
                                <span class="text-muted">Paid on:</span>
                                <strong>{{ order.paid_at|date:"M d, Y - g:i A" }}</strong>
                            </div>
                            {% endif %}

                            {% if order.payment_method %}
                            <div class="flex" style="justify-content: space-between;">
                                <span class="text-muted">Method:</span>
                                <strong>{{ order.payment_method }}</strong>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex" style="justify-content: space-between; align-items: center; gap: var(--space-3);">
                    <a href="{% url 'user_orders' %}" class="pp-btn pp-btn--secondary">
                        <i class="fa-solid fa-arrow-left" style="margin-right: var(--space-2);"></i>
                        Back to orders
                    </a>

                    <div class="flex" style="gap: var(--space-2);">
                        <a href="{% url 'track_order' %}" class="pp-btn pp-btn--secondary">
                            <i class="fa-solid fa-truck"></i>
                            Track order
                        </a>

                        {% if order.status != 'delivered' and order.status != 'cancelled' %}
                        <a href="{% url 'support' %}?order={{ order.id }}" class="pp-btn pp-btn--primary">
                            <i class="fa-solid fa-headset"></i>
                            Need help?
                        </a>
                        {% endif %}

                        {% if order.status == 'delivered' %}
                        <a href="{% url 'products' %}" class="pp-btn pp-btn--primary">
                            <i class="fa-solid fa-bag-shopping"></i>
                            Shop again
                        </a>
                        {% endif %}
                    </div>
                </div>

                <!-- Order Timeline (optional enhancement) -->
                <div class="pp-card">
                    <h3>Order timeline</h3>
                    <div class="stack" style="gap: var(--space-3); margin-top: var(--space-3);">
                        <div class="flex" style="align-items: flex-start; gap: var(--space-3);">
                            <div
                                style="width: 24px; height: 24px; background: var(--color-success); border-radius: var(--radius-full); display: flex; align-items: center; justify-content: center; color: white;">
                                <i class="fa-solid fa-check" style="font-size: var(--text-sm);"></i>
                            </div>
                            <div class="stack" style="gap: 0; flex: 1;">
                                <strong>Order placed</strong>
                                <span class="text-muted" style="font-size: var(--text-sm);">{{ order.created_at|date:"M
                                    d, Y - g:i A" }}</span>
                            </div>
                        </div>

                        {% if order.paid_at %}
                        <div class="flex" style="align-items: flex-start; gap: var(--space-3);">
                            <div
                                style="width: 24px; height: 24px; background: var(--color-success); border-radius: var(--radius-full); display: flex; align-items: center; justify-content: center; color: white;">
                                <i class="fa-solid fa-check"></i>
                            </div>
                            <div class="stack" style="gap: 0; flex: 1;">
                                <strong>Payment confirmed</strong>
                                <span class="text-muted" style="font-size: var(--text-sm);">{{ order.paid_at|date:"M d,
                                    Y - g:i A" }}</span>
                            </div>
                        </div>
                        {% else %}
                        <div class="flex" style="align-items: flex-start; gap: var(--space-3);">
                            <div
                                style="width: 24px; height: 24px; background: var(--color-border); border-radius: var(--radius-full); display: flex; align-items: center; justify-content: center; color: var(--color-text-muted);">
                                <i class="fa-solid fa-clock"></i>
                            </div>
                            <div class="stack" style="gap: 0; flex: 1;">
                                <strong>Awaiting payment</strong>
                                <span class="text-muted" style="font-size: var(--text-sm);">Payment not yet
                                    confirmed</span>
                            </div>
                        </div>
                        {% endif %}

                        {% if order.status == 'shipped' or order.status == 'delivered' %}
                        <div class="flex" style="align-items: flex-start; gap: var(--space-3);">
                            <div
                                style="width: 24px; height: 24px; background: var(--color-success); border-radius: var(--radius-full); display: flex; align-items: center; justify-content: center; color: white;">
                                <i class="fa-solid fa-truck"></i>
                            </div>
                            <div class="stack" style="gap: 0; flex: 1;">
                                <strong>Shipped</strong>
                                <span class="text-muted" style="font-size: var(--text-sm);">Your order is on the
                                    way</span>
                            </div>
                        </div>
                        {% endif %}

                        {% if order.status == 'delivered' %}
                        <div class="flex" style="align-items: flex-start; gap: var(--space-3);">
                            <div
                                style="width: 24px; height: 24px; background: var(--color-success); border-radius: var(--radius-full); display: flex; align-items: center; justify-content: center; color: white;">
                                <i class="fa-solid fa-circle-check"></i>
                            </div>
                            <div class="stack" style="gap: 0; flex: 1;">
                                <strong>Delivered</strong>
                                <span class="text-muted" style="font-size: var(--text-sm);">Order completed</span>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </main>
        </div>
    </div>
</section>

<style>
    /* Sidebar navigation hover effects */
    nav a:hover {
        background: var(--color-surface);
        color: var(--color-primary) !important;
    }

    /* Timeline responsive */
    @media (max-width: 768px) {
        .grid[style*="grid-template-columns: 280px 1fr"] {
            grid-template-columns: 1fr !important;
        }

        .grid[style*="grid-template-columns: 1fr 1fr"] {
            grid-template-columns: 1fr !important;
        }

        .grid[style*="grid-template-columns: 2fr 1fr auto"] {
            grid-template-columns: 1fr !important;
            gap: var(--space-2) !important;
        }

        .grid[style*="grid-template-columns: 2fr 1fr auto"]>* {
            text-align: left !important;
        }

        .grid[style*="grid-template-columns: 2fr 1fr auto"] .pp-btn {
            width: fit-content;
        }

        .flex[style*="justify-content: space-between"] {
            flex-direction: column;
            align-items: stretch !important;
            gap: var(--space-2) !important;
        }

        .flex[style*="justify-content: space-between"] .pp-btn {
            width: 100%;
            justify-content: center;
        }
    }

    @media (max-width: 480px) {
        .grid[style*="grid-template-columns: 1fr 1fr"] {
            grid-template-columns: 1fr !important;
        }

        .pp-card {
            padding: var(--space-4) !important;
        }
    }

    /* Code block styling */
    code {
        font-family: 'SF Mono', Monaco, Consolas, monospace;
        word-break: break-all;
    }

    /* Timeline styling */
    .timeline-item {
        position: relative;
    }
</style>

<script>
    (function () {
        // Highlight current page in sidebar
        const currentPath = window.location.pathname;
        const navLinks = document.querySelectorAll('nav a');

        navLinks.forEach(link => {
            if (link.getAttribute('href') === '/user/orders/') {
                link.style.background = 'var(--color-surface)';
                link.style.color = 'var(--color-primary)';
                link.style.fontWeight = '500';
            }
        });

        // Add smooth scroll to top when navigating
        document.querySelectorAll('a').forEach(link => {
            link.addEventListener('click', (e) => {
                if (link.getAttribute('href')?.startsWith('#')) return;
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        });
    })();
</script>
{% endblock %}