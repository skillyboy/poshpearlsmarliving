{% extends "base.html" %}
{% load humanize %}
{% load static %}

{% block title %}My Orders - PoshPearl{% endblock %}
{% block body_class %}pp-light pp-account{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{% static 'assets/css/light-pages.css' %}?v=20260207">
<link rel="stylesheet" href="{% static 'assets/css/account.css' %}?v=20260207">
{% endblock %}

{% block content %}
<section class="section">
    <div class="container">
        <!-- Account Layout -->
        <div class="grid" style="grid-template-columns: 280px 1fr; gap: var(--space-8);">
            <!-- Sidebar -->
            <aside class="pp-card stack" style="height: fit-content;">
                <div class="flex"
                    style="align-items: center; gap: var(--space-4); padding-bottom: var(--space-4); border-bottom: 1px solid var(--color-border);">
                    <div
                        style="width: 48px; height: 48px; background: var(--color-primary); border-radius: var(--radius-full); display: flex; align-items: center; justify-content: center; color: white; font-weight: 700; font-size: var(--text-xl);">
                        {{ user.first_name|default:user.username|first|upper }}
                    </div>
                    <div class="stack" style="gap: 0;">
                        <strong style="font-size: var(--text-lg);">Hi, {{ user.first_name|default:user.username
                            }}</strong>
                        <span class="text-muted" style="font-size: var(--text-sm);">{{ user.email }}</span>
                    </div>
                </div>

                <nav class="stack" style="gap: var(--space-1);">
                    <a href="{% url 'dashboard' %}" class="flex"
                        style="align-items: center; gap: var(--space-3); padding: var(--space-2) var(--space-3); border-radius: var(--radius-md); color: var(--color-text-muted); transition: all var(--transition-base);">
                        <i class="fa-solid fa-house" style="width: 20px;"></i>
                        <span>Dashboard</span>
                    </a>
                    <a href="{% url 'user_orders' %}" class="flex"
                        style="align-items: center; gap: var(--space-3); padding: var(--space-2) var(--space-3); border-radius: var(--radius-md); background: var(--color-surface); color: var(--color-primary); font-weight: 500;">
                        <i class="fa-solid fa-receipt" style="width: 20px;"></i>
                        <span>Orders</span>
                    </a>
                    <a href="{% url 'wishlist' %}" class="flex"
                        style="align-items: center; gap: var(--space-3); padding: var(--space-2) var(--space-3); border-radius: var(--radius-md); color: var(--color-text-muted); transition: all var(--transition-base);">
                        <i class="fa-solid fa-heart" style="width: 20px;"></i>
                        <span>Wishlist</span>
                    </a>
                    <a href="{% url 'track_order' %}" class="flex"
                        style="align-items: center; gap: var(--space-3); padding: var(--space-2) var(--space-3); border-radius: var(--radius-md); color: var(--color-text-muted); transition: all var(--transition-base);">
                        <i class="fa-solid fa-truck" style="width: 20px;"></i>
                        <span>Track order</span>
                    </a>
                </nav>
            </aside>

            <!-- Main Content -->
            <main class="stack" style="gap: var(--space-6);">
                <!-- Header -->
                <div class="stack" style="gap: var(--space-2);">
                    <p class="pp-pill" style="width: fit-content;">
                        <i class="fa-solid fa-box"></i> Orders
                    </p>
                    <h1 class="pp-section-title">Order history</h1>
                    <p class="text-muted">View and track all your orders.</p>
                </div>

                <!-- Filter Bar -->
                <div class="pp-card">
                    <form method="get" class="grid"
                        style="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: var(--space-3);">
                        <select name="status" class="pp-input">
                            <option value="">All statuses</option>
                            <option value="pending" {% if request.GET.status=='pending' %}selected{% endif %}>Pending
                            </option>
                            <option value="processing" {% if request.GET.status=='processing' %}selected{% endif %}>
                                Processing</option>
                            <option value="shipped" {% if request.GET.status=='shipped' %}selected{% endif %}>Shipped
                            </option>
                            <option value="delivered" {% if request.GET.status=='delivered' %}selected{% endif %}>
                                Delivered</option>
                            <option value="cancelled" {% if request.GET.status=='cancelled' %}selected{% endif %}>
                                Cancelled</option>
                        </select>

                        <input class="pp-input" type="date" name="date_from" value="{{ request.GET.date_from }}"
                            placeholder="From">
                        <input class="pp-input" type="date" name="date_to" value="{{ request.GET.date_to }}"
                            placeholder="To">

                        <div class="flex" style="gap: var(--space-2);">
                            <button class="pp-btn pp-btn--primary" type="submit">Apply filters</button>
                            {% if request.GET.status or request.GET.date_from or request.GET.date_to %}
                            <a href="{% url 'user_orders' %}" class="pp-btn pp-btn--secondary">Clear</a>
                            {% endif %}
                        </div>
                    </form>
                </div>

                <!-- Orders List -->
                {% if orders %}
                <div class="stack" style="gap: var(--space-3);">
                    {% for order in orders %}
                    <div class="pp-card" style="padding: var(--space-4);">
                        <div class="grid"
                            style="grid-template-columns: 1fr auto auto auto; align-items: center; gap: var(--space-4);">
                            <!-- Order Info -->
                            <div class="stack" style="gap: var(--space-1);">
                                <strong style="font-size: var(--text-lg);">Order #{{ order.id }}</strong>
                                <span class="text-muted" style="font-size: var(--text-sm);">{{ order.created_at|date:"F
                                    d, Y - g:i A" }}</span>
                                {% if order.items.count %}
                                <span class="text-muted" style="font-size: var(--text-sm);">{{ order.items.count }}
                                    item{{ order.items.count|pluralize }}</span>
                                {% endif %}
                            </div>

                            <!-- Status -->
                            <div>
                                <span class="pp-pill" style="background: 
                                    {% if order.status == 'delivered' %}var(--color-success)
                                    {% elif order.status == 'cancelled' %}var(--color-danger)
                                    {% elif order.status == 'shipped' %}var(--color-accent)
                                    {% elif order.status == 'processing' %}#f59e0b
                                    {% else %}var(--color-text-muted){% endif %}; 
                                    color: white; padding: var(--space-2) var(--space-4);">
                                    {{ order.get_status_display }}
                                </span>
                                {% if order.payment_status == 'paid' %}
                                <span class="text-muted"
                                    style="display: block; font-size: var(--text-sm); margin-top: var(--space-1);">✓
                                    Paid</span>
                                {% else %}
                                <span class="text-muted"
                                    style="display: block; font-size: var(--text-sm); margin-top: var(--space-1);">⏳ {{
                                    order.get_payment_status_display }}</span>
                                {% endif %}
                            </div>

                            <!-- Total -->
                            <div style="text-align: right;">
                                <strong style="font-size: var(--text-xl); color: var(--color-primary);">{{
                                    order.currency }} {{ order.amount|intcomma }}</strong>
                                <div class="text-muted" style="font-size: var(--text-sm);">Total</div>
                            </div>

                            <!-- Actions -->
                            <div>
                                <a href="{% url 'user_order_detail' order.id %}" class="pp-btn pp-btn--primary"
                                    style="white-space: nowrap;">
                                    View details
                                    <i class="fa-solid fa-arrow-right" style="margin-left: var(--space-2);"></i>
                                </a>
                            </div>
                        </div>

                        <!-- Quick Preview of Items (optional) -->
                        {% if order.items.all|slice:":2" %}
                        <div class="flex"
                            style="gap: var(--space-2); margin-top: var(--space-3); padding-top: var(--space-3); border-top: 1px dashed var(--color-border);">
                            {% for item in order.items.all|slice:":2" %}
                            <div class="flex" style="align-items: center; gap: var(--space-2);">
                                {% if item.product and item.product.images.first %}
                                <img src="{{ item.product.images.first.image.url }}" alt=""
                                    style="width: 32px; height: 32px; object-fit: cover; border-radius: var(--radius-sm);">
                                {% else %}
                                <div
                                    style="width: 32px; height: 32px; background: var(--color-surface); border-radius: var(--radius-sm); display: flex; align-items: center; justify-content: center;">
                                    <i class="fa-solid fa-box" style="color: var(--color-text-muted);"></i>
                                </div>
                                {% endif %}
                                <span class="text-muted" style="font-size: var(--text-sm);">{{
                                    item.product.name|default:"Product" }} ×{{ item.quantity }}</span>
                            </div>
                            {% endfor %}
                            {% if order.items.count > 2 %}
                            <span class="text-muted" style="font-size: var(--text-sm);">+{{ order.items.count|add:"-2"
                                }} more</span>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>

                <!-- Pagination -->
                {% if is_paginated %}
                <nav class="flex" style="justify-content: center; gap: var(--space-2); margin-top: var(--space-6);">
                    {% if page_obj.has_previous %}
                    <a href="?page={{ page_obj.previous_page_number }}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.date_from %}&date_from={{ request.GET.date_from }}{% endif %}{% if request.GET.date_to %}&date_to={{ request.GET.date_to }}{% endif %}"
                        class="pp-btn pp-btn--secondary">
                        <i class="fa-solid fa-chevron-left"></i>
                        Previous
                    </a>
                    {% endif %}

                    <span class="pp-pill" style="padding: var(--space-2) var(--space-4);">
                        Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                    </span>

                    {% if page_obj.has_next %}
                    <a href="?page={{ page_obj.next_page_number }}{% if request.GET.status %}&status={{ request.GET.status }}{% endif %}{% if request.GET.date_from %}&date_from={{ request.GET.date_from }}{% endif %}{% if request.GET.date_to %}&date_to={{ request.GET.date_to }}{% endif %}"
                        class="pp-btn pp-btn--secondary">
                        Next
                        <i class="fa-solid fa-chevron-right"></i>
                    </a>
                    {% endif %}
                </nav>
                {% endif %}

                {% else %}
                <!-- Empty State -->
                <div class="pp-card text-center stack" style="padding: var(--space-12);">
                    <div style="font-size: 4rem; color: var(--color-text-muted);">
                        <i class="fa-solid fa-box-open"></i>
                    </div>
                    <h2>No orders yet</h2>
                    <p class="text-muted" style="max-width: 400px; margin: 0 auto;">Start shopping to see your order
                        history here. We have a wide selection of smart home products waiting for you.</p>
                    <div class="flex" style="justify-content: center; gap: var(--space-3); margin-top: var(--space-4);">
                        <a class="pp-btn pp-btn--primary" href="{% url 'products' %}">
                            <i class="fa-solid fa-bag-shopping" style="margin-right: var(--space-2);"></i>
                            Browse products
                        </a>
                        <a class="pp-btn pp-btn--secondary" href="{% url 'contact' %}">
                            <i class="fa-solid fa-headset"></i>
                            Contact support
                        </a>
                    </div>
                </div>
                {% endif %}

                <!-- Order Stats Summary (optional) -->
                {% if orders %}
                <div class="grid" style="grid-template-columns: repeat(4, 1fr); gap: var(--space-3);">
                    <div class="pp-card text-center">
                        <span class="text-muted">Total orders</span>
                        <strong style="display: block; font-size: var(--text-2xl); color: var(--color-primary);">{{
                            orders_total|default:orders|length }}</strong>
                    </div>
                    <div class="pp-card text-center">
                        <span class="text-muted">Delivered</span>
                        <strong style="display: block; font-size: var(--text-2xl); color: var(--color-success);">{{
                            delivered_count|default:0 }}</strong>
                    </div>
                    <div class="pp-card text-center">
                        <span class="text-muted">Processing</span>
                        <strong style="display: block; font-size: var(--text-2xl); color: #f59e0b;">{{
                            processing_count|default:0 }}</strong>
                    </div>
                    <div class="pp-card text-center">
                        <span class="text-muted">Total spent</span>
                        <strong style="display: block; font-size: var(--text-2xl); color: var(--color-primary);">NGN {{
                            total_spent|default:0|intcomma }}</strong>
                    </div>
                </div>
                {% endif %}
            </main>
        </div>
    </div>
</section>

<style>
    /* Sidebar navigation hover effects */
    nav a:hover {
        background: var(--color-surface);
        color: var(--color-primary) !important;
    }

    /* Responsive */
    @media (max-width: 1024px) {
        .grid[style*="grid-template-columns: 1fr auto auto auto"] {
            grid-template-columns: 1fr 1fr !important;
            gap: var(--space-3) !important;
        }

        .grid[style*="grid-template-columns: 1fr auto auto auto"]>div:last-child {
            grid-column: span 2;
        }
    }

    @media (max-width: 768px) {
        .grid[style*="grid-template-columns: 280px 1fr"] {
            grid-template-columns: 1fr !important;
        }

        .grid[style*="grid-template-columns: repeat(4, 1fr)"] {
            grid-template-columns: repeat(2, 1fr) !important;
        }

        .grid[style*="grid-template-columns: 1fr auto auto auto"] {
            grid-template-columns: 1fr !important;
        }

        .grid[style*="grid-template-columns: 1fr auto auto auto"]>div {
            text-align: left !important;
        }

        .grid[style*="grid-template-columns: 1fr auto auto auto"]>div:last-child {
            grid-column: span 1;
        }

        .pp-btn {
            width: 100%;
            justify-content: center;
        }

        .flex[style*="justify-content: center"] {
            flex-direction: column;
        }
    }

    @media (max-width: 480px) {
        .grid[style*="grid-template-columns: repeat(4, 1fr)"] {
            grid-template-columns: 1fr !important;
        }

        .grid[style*="grid-template-columns: repeat(auto-fit, minmax(180px, 1fr))"] {
            grid-template-columns: 1fr !important;
        }
    }

    /* Animation for empty state */
    .fa-box-open {
        animation: float 3s ease-in-out infinite;
    }

    @keyframes float {

        0%,
        100% {
            transform: translateY(0);
        }

        50% {
            transform: translateY(-10px);
        }
    }
</style>

<script>
    (function () {
        // Highlight current page in sidebar
        const currentPath = window.location.pathname;
        const navLinks = document.querySelectorAll('nav a');

        navLinks.forEach(link => {
            if (link.getAttribute('href') === '/user/orders/') {
                link.style.background = 'var(--color-surface)';
                link.style.color = 'var(--color-primary)';
                link.style.fontWeight = '500';
            }
        });

        // Auto-submit filters when status changes (optional)
        const statusSelect = document.querySelector('select[name="status"]');
        if (statusSelect) {
            statusSelect.addEventListener('change', () => {
                statusSelect.closest('form').submit();
            });
        }

        // Add smooth scroll to top
        document.querySelectorAll('a[href^="?page"]').forEach(link => {
            link.addEventListener('click', () => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });
        });
    })();
</script>
{% endblock %}