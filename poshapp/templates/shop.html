{% extends "base.html" %}
{% load humanize %}
{% load static %}

{% block title %}{% if product %}{{ product.name }} - PoshPearl{% else %}Shop - PoshPearl{% endif %}{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{% static 'assets/css/poshapp-shop.css' %}">
{% endblock %}

{% block body_class %}pp-shop{% endblock %}

{% block content %}
<main class="pp-main" id="top">
  {% static 'assets/images/products/d2pro1.jpeg' as product_fallback %}

  {% if product %}
  <section class="pp-hero" id="overview" data-section>
    <div class="container pp-hero__grid">
      <header class="pp-hero__content">
        <nav class="pp-breadcrumb" aria-label="Breadcrumb">
          <a href="{% url 'home' %}">Home</a>
          <span aria-hidden="true">/</span>
          <a href="{% url 'products' %}">Products</a>
          <span aria-hidden="true">/</span>
          <span aria-current="page">{{ product.name }}</span>
        </nav>

        <div class="pp-hero__eyebrow">
          <span class="pp-badge">Wholesale pricing</span>
          <span class="pp-hero__stock">
            {% if product.stock_quantity > 0 %}
              {{ product.stock_quantity }} in stock
            {% else %}
              On request
            {% endif %}
          </span>
        </div>

        <h1 class="pp-hero__title">{{ product.name }}</h1>

        {% if product.short_description %}
          <p class="pp-hero__lead">{{ product.short_description }}</p>
        {% elif product.description %}
          <p class="pp-hero__lead">{{ product.description|truncatewords:32 }}</p>
        {% endif %}

        <ul class="pp-hero__highlights" aria-label="Key highlights">
          <li>3D face recognition</li>
          <li>Palm vein unlock</li>
          <li>Wi-Fi control</li>
        </ul>

        <div class="pp-hero__cta-card">
          <div class="pp-hero__price">
            <span>Starting from</span>
            <strong>
              {% if product.price_tiers.first %}
                {{ product.currency }} {{ product.price_tiers.first.price|intcomma }}
                <small>/unit ({{ product.price_tiers.first.min_quantity }}+)</small>
              {% elif product.price %}
                {{ product.currency }} {{ product.price|intcomma }}
              {% else %}
                On request
              {% endif %}
            </strong>
          </div>

          <div class="pp-hero__actions" role="group" aria-label="Purchase actions">
            <button class="pp-btn primary" type="button" data-modal-target="quote">
              Request quote
            </button>

            <div class="pp-qty-select" aria-label="Select quantity">
              <label for="pp-qty" class="pp-qty-select__label">Qty</label>
              <input
                id="pp-qty"
                name="quantity"
                type="number"
                min="1"
                value="1"
                inputmode="numeric"
                data-add-qty
                aria-label="Quantity"
              >
            </div>

            <button
              class="pp-btn"
              type="button"
              data-add-to-cart
              data-product-id="{{ product.id }}"
              aria-label="Add to cart"
            >
              Add to cart
            </button>

            <a class="pp-btn ghost" href="/support/">Ask support</a>
          </div>

          <p class="pp-hero__note">
            Bulk-ready pricing, dedicated onboarding, and fast fulfillment for verified distributors.
          </p>

          <div class="pp-trust" aria-label="Trust signals">
            <div class="pp-trust__item">
              <i class="fa-solid fa-shield-halved" aria-hidden="true"></i>
              <span>2-year warranty</span>
            </div>
            <div class="pp-trust__item">
              <i class="fa-solid fa-truck-fast" aria-hidden="true"></i>
              <span>Fast delivery</span>
            </div>
            <div class="pp-trust__item">
              <i class="fa-solid fa-headset" aria-hidden="true"></i>
              <span>Dedicated support</span>
            </div>
          </div>
        </div>

        <div class="pp-hero__meta" aria-label="Product metadata">
          <div class="pp-meta-card">
            <span>SKU</span>
            <strong>{{ product.sku|default:"N/A" }}</strong>
          </div>
          <div class="pp-meta-card">
            <span>Availability</span>
            <strong>
              {% if product.stock_quantity > 0 %}
                {{ product.stock_quantity }} units
              {% else %}
                On request
              {% endif %}
            </strong>
          </div>
          <div class="pp-meta-card">
            <span>Currency</span>
            <strong>{{ product.currency }}</strong>
          </div>
        </div>

        {% if product.categories.exists %}
        <div class="pp-chip-list" aria-label="Product categories">
          {% for category in product.categories.all %}
            <span class="pp-chip">{{ category.name }}</span>
          {% endfor %}
        </div>
        {% endif %}
      </header>

      <aside class="pp-hero__panel" aria-label="Product summary">
        {% with hero_image=product.images.first %}
          <div class="pp-hero__media">
            {% if hero_image %}
              <img
                src="{{ hero_image.image.url }}"
                alt="{{ hero_image.alt_text|default:product.name }}"
                loading="eager"
                decoding="async"
                width="640"
                height="800"
              >
            {% else %}
              <img
                src="{{ product_fallback }}"
                alt="{{ product.name }}"
                loading="eager"
                decoding="async"
                width="640"
                height="800"
              >
            {% endif %}
          </div>
        {% endwith %}

        <div class="pp-hero__panel-body">
          {% with first_tier=product.price_tiers.first %}
            <div class="pp-stat" aria-label="Starting tier">
              <span class="pp-stat__label">Starting tier</span>
              <span class="pp-stat__value">
                {% if first_tier %}
                  {{ first_tier.currency }} {{ first_tier.price|intcomma }}
                  <span class="pp-stat__sub">for {{ first_tier.min_quantity }}+ pcs</span>
                {% elif product.price %}
                  {{ product.currency }} {{ product.price|intcomma }}
                {% else %}
                  On request
                {% endif %}
              </span>
            </div>
          {% endwith %}

          {% if product.compare_at_price %}
          <div class="pp-stat" aria-label="List price">
            <span class="pp-stat__label">List price</span>
            <span class="pp-stat__value pp-stat__value--muted">
              {{ product.currency }} {{ product.compare_at_price|intcomma }}
            </span>
          </div>
          {% endif %}

          <div class="pp-hero__panel-links" aria-label="Jump links">
            <a href="#gallery" data-scroll>View gallery</a>
            <a href="#pricing" data-scroll>View pricing tiers</a>
          </div>
        </div>
      </aside>
    </div>
  </section>

  <nav class="pp-section-nav" aria-label="On this page">
    <div class="container">
      <a href="#gallery" data-scroll data-section-link>Gallery</a>
      <a href="#pricing" data-scroll data-section-link>Pricing</a>
      <a href="#details" data-scroll data-section-link>Details</a>
      <a href="#benefits" data-scroll data-section-link>Benefits</a>
      <a href="#catalog" data-scroll data-section-link>Related</a>
      <a href="#request" data-scroll data-section-link>Request</a>
    </div>
  </nav>

  <section class="pp-section" id="gallery" data-section>
    <div class="container">
      <div class="pp-section__header">
        <h2>Product gallery</h2>
        <p class="pp-muted">Tap any image to zoom. Use arrow keys in preview.</p>
      </div>

      <div class="pp-gallery" data-gallery>
        {% if product.images.exists %}
          {% for image in product.images.all %}
            {% if forloop.first %}
              <div class="pp-gallery__stage">
                <button
                  class="pp-gallery__main pp-skeleton"
                  type="button"
                  data-gallery-main
                  data-modal-image="{{ image.image.url }}"
                  data-modal-alt="{{ image.alt_text|default:product.name }}"
                  aria-label="Open image preview"
                >
                  <img
                    src="{{ image.image.url }}"
                    alt="{{ image.alt_text|default:product.name }}"
                    loading="eager"
                    decoding="async"
                    width="880"
                    height="1100"
                  >
                </button>
                <span class="pp-gallery__hint">Tap to zoom</span>
                <span class="pp-gallery__count">{{ product.images.count }} images</span>
              </div>
            {% endif %}
          {% endfor %}

          <div class="pp-gallery__thumbs" aria-label="Gallery thumbnails">
            {% for image in product.images.all %}
              <button
                class="pp-gallery__thumb{% if forloop.first %} is-active{% endif %}"
                type="button"
                data-gallery-thumb
                data-preview-src="{{ image.image.url }}"
                data-preview-alt="{{ image.alt_text|default:product.name }}"
                aria-label="Select image {{ forloop.counter }}"
              >
                <img
                  src="{{ image.image.url }}"
                  alt="{{ image.alt_text|default:product.name }}"
                  loading="lazy"
                  decoding="async"
                  width="240"
                  height="320"
                >
              </button>
            {% endfor %}
          </div>
        {% else %}
          <div class="pp-gallery__stage">
            <button
              class="pp-gallery__main pp-skeleton"
              type="button"
              data-gallery-main
              data-modal-image="{{ product_fallback }}"
              data-modal-alt="{{ product.name }}"
              aria-label="Open image preview"
            >
              <img
                src="{{ product_fallback }}"
                alt="{{ product.name }}"
                loading="eager"
                decoding="async"
                width="880"
                height="1100"
              >
            </button>
            <span class="pp-gallery__hint">Tap to zoom</span>
          </div>
        {% endif %}
      </div>
    </div>
  </section>

  <section class="pp-section" id="pricing" data-section>
    <div class="container">
      <div class="pp-section__header">
        <h2>Wholesale tiers</h2>
        <p class="pp-muted">Set your quantity above to see the best tier auto highlight.</p>
      </div>

      <div class="pp-price-card">
        <table class="pp-table" aria-label="Wholesale pricing tiers">
          <thead>
            <tr>
              <th scope="col">Quantity</th>
              <th scope="col">Price</th>
            </tr>
          </thead>
          <tbody>
            {% if product.price_tiers.exists %}
              {% for tier in product.price_tiers.all %}
                <tr class="pp-tier-row" data-min="{{ tier.min_quantity }}" data-price="{{ tier.price }}">
                  <td>
                    <span class="pp-qty">{{ tier.min_quantity }} pieces</span>
                    {% if tier.label %}
                      <span class="pp-chip pp-chip--accent">{{ tier.label }}</span>
                    {% endif %}
                  </td>
                  <td>
                    <span class="pp-price">
                      {{ tier.currency }} {{ tier.price|intcomma }}
                    </span>
                  </td>
                </tr>
              {% endfor %}
            {% elif product.price %}
              <tr class="pp-tier-row" data-min="1" data-price="{{ product.price }}">
                <td>Single unit</td>
                <td><span class="pp-price">{{ product.currency }} {{ product.price|intcomma }}</span></td>
              </tr>
            {% else %}
              <tr>
                <td colspan="2">Pricing not available.</td>
              </tr>
            {% endif %}
          </tbody>
        </table>
      </div>
    </div>
  </section>

  <section class="pp-section" id="details" data-section>
    <div class="container">
      <div class="pp-section__header">
        <h2>Product details</h2>
        <p>Key highlights and deployment notes for resellers and bulk procurement.</p>
      </div>

      <div class="pp-details">
        <div class="pp-details__copy">
          {% if product.description %}
            <p>{{ product.description }}</p>
          {% else %}
            <p>Designed for modern access control with premium hardware, reliable connectivity, and long-term support.</p>
          {% endif %}

          <ul class="pp-feature-list">
            <li>Face recognition + palm vein unlock</li>
            <li>Remote access with mobile management</li>
            <li>Multi-user profiles and audit trail</li>
            <li>Installer-ready kit for fast rollout</li>
          </ul>
        </div>

        <aside class="pp-specs" aria-label="Technical specs">
          <h3>Technical specs</h3>
          <div class="pp-specs__row">
            <span>Access modes</span>
            <strong>Face, fingerprint, keypad, mechanical key</strong>
          </div>
          <div class="pp-specs__row">
            <span>Connectivity</span>
            <strong>Wi-Fi + mobile app</strong>
          </div>
          <div class="pp-specs__row">
            <span>Installation</span>
            <strong>Standard smart lock fit</strong>
          </div>
          <div class="pp-specs__row">
            <span>Support</span>
            <strong>Distributor onboarding + after-sales</strong>
          </div>
        </aside>

        <div class="pp-details__grid">
          <article class="pp-detail-card">
            <h3>Access modes</h3>
            <p>Face recognition, fingerprint, keypad, and key override options.</p>
          </article>
          <article class="pp-detail-card">
            <h3>Remote control</h3>
            <p>App-based access management with live notifications and audit trail.</p>
          </article>
          <article class="pp-detail-card">
            <h3>Installer ready</h3>
            <p>Streamlined install kit with clear guides for fast deployment.</p>
          </article>
          <article class="pp-detail-card">
            <h3>Distributor support</h3>
            <p>Dedicated onboarding, bulk pricing, and after-sales support.</p>
          </article>
        </div>
      </div>
    </div>
  </section>

  <section class="pp-section" id="benefits" data-section>
    <div class="container">
      <div class="pp-section__header">
        <h2>Why distributors choose D2pro</h2>
        <p>Built for scale, reliability, and premium client experiences.</p>
      </div>

      <div class="pp-feature-grid">
        <article class="pp-feature-card">
          <i class="fa-solid fa-people-group" aria-hidden="true"></i>
          <h3>Multi-site ready</h3>
          <p>Deploy across residential and commercial projects with consistent setup workflows.</p>
        </article>

        <article class="pp-feature-card">
          <i class="fa-solid fa-chart-line" aria-hidden="true"></i>
          <h3>Profit-friendly tiers</h3>
          <p>Clear wholesale breaks and reliable restock support for large orders.</p>
        </article>

        <article class="pp-feature-card">
          <i class="fa-solid fa-sliders" aria-hidden="true"></i>
          <h3>Flexible onboarding</h3>
          <p>We provide training, install guidance, and co-branded materials.</p>
        </article>
      </div>
    </div>
  </section>

  <section class="pp-section" id="request" data-section>
    <div class="container">
      <div class="pp-request">
        <div class="pp-request__copy">
          <h2>Request a distributor quote</h2>
          <p>Share your expected volume and delivery location for a tailored response.</p>
        </div>
        <div class="pp-request__actions">
          <button class="pp-btn primary" type="button" data-modal-target="quote">Request quote</button>
          <a class="pp-btn ghost" href="/contact/">Contact</a>
        </div>
      </div>
    </div>
  </section>

  <div class="pp-purchase-bar" aria-label="Quick purchase" data-purchase-bar>
    <div class="pp-purchase-bar__content">
      <span class="pp-purchase-bar__name">{{ product.name }}</span>
      <div class="pp-purchase-bar__actions">
        <button class="pp-btn" type="button" data-add-to-cart data-product-id="{{ product.id }}">Add to cart</button>
        <a class="pp-btn primary" href="{% url 'checkout' %}">Checkout</a>
      </div>
    </div>
  </div>
  {% else %}
  <section class="pp-empty">
    <div class="container">
      <nav class="pp-breadcrumb" aria-label="Breadcrumb">
        <a href="{% url 'home' %}">Home</a>
        <span aria-hidden="true">/</span>
        <a href="{% url 'products' %}">Products</a>
        <span aria-hidden="true">/</span>
        <span aria-current="page">Catalog</span>
      </nav>
      <h1 class="pp-hero__title">Product catalog</h1>
      <p class="pp-hero__lead">Browse our premium collection of smart home security solutions.</p>
    </div>
  </section>
  {% endif %}

  {% if products %}
  <section id="catalog" class="pp-section" data-section>
    <div class="container">
      <div class="pp-section__header">
        <h2>Related products</h2>
        <p class="pp-muted">Explore other distributor-ready smart lock options.</p>
      </div>

      <div class="pp-catalog">
        {% for item in products %}
        <article class="pp-product-card">
          <a class="pp-product-card__media" href="{% url 'product_detail_products' slug=item.slug %}">
            {% with card_image=item.images.first %}
              <img src="{{ card_image.image.url|default:product_fallback }}" alt="{{ item.name }}" loading="lazy" onerror="this.onerror=null;this.src='{{ product_fallback }}';">
            {% endwith %}
            {% if item.stock_quantity == 0 %}
              <span class="pp-product-card__badge">Out of stock</span>
            {% endif %}
          </a>
          <div class="pp-product-card__body">
            <div class="pp-product-card__meta">
              {% for cat in item.categories.all|slice:":1" %}
                <span class="pp-chip">{{ cat.name }}</span>
              {% endfor %}
            </div>
            <h3>
              <a href="{% url 'product_detail_products' slug=item.slug %}">{{ item.name }}</a>
            </h3>
            <p>{{ item.short_description|default:item.description|truncatechars:90 }}</p>
            <div class="pp-product-card__footer">
              <span class="pp-price">
                {% if item.price_tiers.exists %}
                  {{ item.currency }} {{ item.price_tiers.first.price|intcomma }}
                {% elif item.price %}
                  {{ item.currency }} {{ item.price|intcomma }}
                {% else %}
                  On request
                {% endif %}
              </span>
              <button class="pp-btn" data-add-to-cart data-product-id="{{ item.id }}">Add</button>
            </div>
          </div>
        </article>
        {% endfor %}
      </div>
    </div>
  </section>
  {% endif %}

  <template id="quote-form-template">
    <form class="pp-form" data-validate>
      <div class="pp-field">
        <label for="quote-name">Full name</label>
        <input id="quote-name" name="name" type="text" required aria-describedby="quote-name-error">
        <div class="pp-field__error" id="quote-name-error" role="status"></div>
      </div>

      <div class="pp-field">
        <label for="quote-email">Email address</label>
        <input id="quote-email" name="email" type="email" required aria-describedby="quote-email-error">
        <div class="pp-field__error" id="quote-email-error" role="status"></div>
      </div>

      <div class="pp-field">
        <label for="quote-qty">Estimated quantity</label>
        <input id="quote-qty" name="quantity" type="number" min="1" placeholder="e.g. 100" required aria-describedby="quote-qty-error">
        <div class="pp-field__error" id="quote-qty-error" role="status"></div>
      </div>

      <div class="pp-field">
        <label for="quote-notes">Delivery location</label>
        <input id="quote-notes" name="location" type="text" placeholder="City, Country" aria-describedby="quote-notes-error">
        <div class="pp-field__error" id="quote-notes-error" role="status"></div>
      </div>

      <div class="pp-field">
        <label for="quote-message">Message</label>
        <textarea id="quote-message" name="message" rows="4" placeholder="Any special requirements?" aria-describedby="quote-message-error"></textarea>
        <div class="pp-field__error" id="quote-message-error" role="status"></div>
      </div>

      <button class="pp-btn primary" type="submit">Send request</button>
    </form>
  </template>
</main>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    var bar = document.querySelector('[data-purchase-bar]');
    var hero = document.getElementById('overview');
    if (bar && hero && typeof IntersectionObserver !== 'undefined') {
      bar.classList.add('is-floating');
      var observer = new IntersectionObserver(function (entries) {
        entries.forEach(function (entry) {
          bar.classList.toggle('is-visible', !entry.isIntersecting);
        });
      }, { rootMargin: '-80px 0px 0px 0px', threshold: 0.1 });
      observer.observe(hero);
    }

    var qtyInput = document.getElementById('pp-qty');
    var tierRows = Array.prototype.slice.call(document.querySelectorAll('.pp-tier-row'));
    function highlightTier() {
      if (!qtyInput || !tierRows.length) return;
      var qty = parseInt(qtyInput.value || '1', 10);
      var activeRow = null;
      tierRows.forEach(function (row) {
        var minQty = parseInt(row.getAttribute('data-min') || '0', 10);
        if (qty >= minQty) {
          activeRow = row;
        }
        row.classList.remove('is-highlight');
      });
      if (activeRow) activeRow.classList.add('is-highlight');
    }
    if (qtyInput) {
      qtyInput.addEventListener('input', highlightTier);
      highlightTier();
    }

    var galleryMain = document.querySelector('[data-gallery-main] img');
    var galleryButtons = document.querySelectorAll('[data-gallery-thumb]');
    galleryButtons.forEach(function (btn) {
      btn.addEventListener('click', function () {
        var src = btn.getAttribute('data-preview-src');
        var alt = btn.getAttribute('data-preview-alt');
        if (galleryMain && src) {
          galleryMain.src = src;
          galleryMain.alt = alt || '';
        }
        galleryButtons.forEach(function (b) { b.classList.remove('is-active'); });
        btn.classList.add('is-active');
      });
    });

    function openModal(contentNode, ariaLabel) {
      var overlay = document.createElement('div');
      overlay.className = 'pp-modal is-open';
      overlay.setAttribute('role', 'dialog');
      overlay.setAttribute('aria-modal', 'true');
      overlay.setAttribute('aria-label', ariaLabel || 'Dialog');
      overlay.innerHTML = '<div class="pp-modal__dialog"><button class="pp-modal__close" type="button" aria-label="Close">&times;</button><div class="pp-modal__content"></div></div>';
      document.body.appendChild(overlay);
      var content = overlay.querySelector('.pp-modal__content');
      content.appendChild(contentNode);
      overlay.querySelector('.pp-modal__close').addEventListener('click', function () { overlay.remove(); });
      overlay.addEventListener('click', function (e) { if (e.target === overlay) overlay.remove(); });
      document.addEventListener('keydown', function esc(e) {
        if (e.key === 'Escape') {
          overlay.remove();
          document.removeEventListener('keydown', esc);
        }
      });
      var firstInput = overlay.querySelector('input, textarea, button');
      if (firstInput) firstInput.focus();
    }

    document.querySelectorAll('[data-modal-target="quote"]').forEach(function (btn) {
      btn.addEventListener('click', function () {
        var tpl = document.getElementById('quote-form-template');
        if (!tpl) return;
        openModal(tpl.content.cloneNode(true), 'Request quote');
      });
    });

    document.querySelectorAll('[data-gallery-main]').forEach(function (btn) {
      btn.addEventListener('click', function () {
        var src = btn.getAttribute('data-modal-image');
        var alt = btn.getAttribute('data-modal-alt') || 'Product image';
        if (!src) return;
        var figure = document.createElement('figure');
        figure.innerHTML = '<img src="' + src + '" alt="' + alt + '">';
        openModal(figure, 'Image preview');
      });
    });
  });
</script>
{% endblock %}
