{% extends "base.html" %}
{% load static %}
{% load humanize %}

{% block title %}{{ product.name }} - PoshPearl{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{% static 'assets/css/products.css' %}?v={{ STATIC_ASSET_VERSION }}">
<link rel="stylesheet" href="{% static 'assets/css/product-detail.css' %}?v={{ STATIC_ASSET_VERSION }}">
{% endblock %}

{% block body_class %}pp-light pp-products pp-product-detail{% endblock %}

{% block content %}
<div class="pp-detail">
  {% static 'assets/images/products/d2pro1.jpeg' as product_fallback %}

  <section class="section">
    <div class="container">
      <nav class="pp-breadcrumb pp-detail__breadcrumb" aria-label="Breadcrumb">
        <a href="{% url 'home' %}">Home</a>
        <span aria-hidden="true">/</span>
        <a href="{% url 'products' %}">Products</a>
        {% if product.categories.exists %}
        <span aria-hidden="true">/</span>
        <span>{{ product.categories.first.name }}</span>
        {% endif %}
        <span aria-hidden="true">/</span>
        <span aria-current="page">{{ product.name }}</span>
      </nav>

      <div class="pp-detail__layout">
        <aside class="pp-card stack pp-detail__filters">
          <div class="pp-detail__filter-head">
            <h3>Filters</h3>
            <a href="{% url 'products' %}" class="text-muted">Reset</a>
          </div>

          <div class="stack">
            <h4>Category</h4>
            <div class="stack pp-detail__checklist">
              {% for category in categories %}
              <label class="pp-detail__check">
                <input type="checkbox" {% if category in product.categories.all %}checked{% endif %}>
                <span>{{ category.name }}</span>
              </label>
              {% endfor %}
            </div>
          </div>

          <div class="stack">
            <h4>Availability</h4>
            <label class="pp-detail__check">
              <input type="checkbox" {% if product.stock_quantity > 0 %}checked{% endif %}>
              <span>In stock</span>
            </label>
          </div>

          <div class="stack">
            <h4>Compatibility</h4>
            <div class="stack pp-detail__checklist">
              <label class="pp-detail__check"><input type="checkbox" checked><span>Alexa</span></label>
              <label class="pp-detail__check"><input type="checkbox"><span>Google</span></label>
              <label class="pp-detail__check"><input type="checkbox" checked><span>App Control</span></label>
            </div>
          </div>
        </aside>

        <section class="pp-detail__summary">
          <div class="pp-detail__media stack" data-gallery>
            {% with hero_image=product.images.first %}
            <div class="pp-detail__main" data-gallery-main
              data-modal-image="{{ hero_image.image.url|default:product_fallback }}" data-modal-alt="{{ product.name }}">
              <img class="pp-detail__main-image" src="{{ hero_image.image.url|default:product_fallback }}"
                alt="{{ product.name }}" loading="eager" decoding="async">
            </div>
            {% endwith %}

            <div class="pp-detail__thumbs">
              {% for image in product.images.all|slice:":4" %}
              <button class="pp-detail__thumb{% if forloop.first %} is-active{% endif %}" type="button"
                data-gallery-thumb data-preview-src="{{ image.image.url }}"
                data-preview-alt="{{ image.alt_text|default:product.name }}">
                <img src="{{ image.image.url }}" alt="{{ image.alt_text|default:product.name }}" loading="lazy"
                  decoding="async">
              </button>
              {% endfor %}
              {% if not product.images.exists %}
              <button class="pp-detail__thumb is-active" type="button">
                <img src="{{ product_fallback }}" alt="{{ product.name }}">
              </button>
              {% endif %}
            </div>
          </div>

          <div class="stack pp-detail__info">
            <div>
              <span class="pp-pill pp-detail__stock-badge{% if product.stock_quantity > 0 %} is-instock{% else %} is-preorder{% endif %}">
                {% if product.stock_quantity > 0 %}In stock{% else %}Limited Pre-order{% endif %}
              </span>
            </div>

            <h1 class="pp-detail__title">{{ product.name }}</h1>

            <div class="pp-detail__rating">
              <span class="pp-detail__stars">&#9733;&#9733;&#9733;&#9733;&#9733;</span>
              <span class="text-muted">4.8 (36 reviews)</span>
            </div>

            <div class="pp-detail__price-row">
              <div class="pp-detail__price">
                {% if product.price_tiers.exists %}
                {{ product.currency }} {{ product.price_tiers.first.price|intcomma }}
                {% elif product.price %}
                {{ product.currency }} {{ product.price|intcomma }}
                {% else %}
                On request
                {% endif %}
              </div>
              {% if tier_savings or product.compare_at_price %}
              <div class="pp-pill pp-detail__save-pill">
                Save {{ product.currency }} {{ tier_savings|default:product.compare_at_price|intcomma }}
              </div>
              {% endif %}
            </div>

            {% if first_tier_max %}
            <p class="text-muted">First {{ first_tier_max }} units only</p>
            {% endif %}

            {% if product.compare_at_price %}
            <p class="text-muted">Retail price: {{ product.currency }} {{ product.compare_at_price|intcomma }}</p>
            {% endif %}

            {% if price_tier_ranges %}
            <div class="pp-card pp-detail__tier-card">
              <h4>Volume Pricing</h4>
              <div class="stack">
                {% for tier in price_tier_ranges %}
                <div class="pp-detail__tier-row">
                  <span>
                    {% if tier.max %}
                    {{ tier.min }}-{{ tier.max }} units
                    {% else %}
                    {{ tier.min }}+ units
                    {% endif %}
                  </span>
                  <strong>{{ tier.currency }} {{ tier.price|intcomma }}</strong>
                </div>
                {% endfor %}
              </div>
            </div>
            {% endif %}

            {% with product.slug|default_if_none:''|lower as slug_lower %}
            {% if "d2pro" in slug_lower %}
            <div class="pp-card pp-bulk-card pp-bulk-card--brand">
              <div class="stack">
                <p class="pp-pill pp-bulk-card__eyebrow">Bulk pricing</p>
                <h3>D2Pro Smart Lock</h3>
                <p>Volume discounts applied per order.</p>
                <div class="stack pp-bulk-card__rows">
                  <div class="pp-bulk-row pp-bulk-row--burgundy">
                    <span>1-20 units</span><strong>NGN 320,000</strong><span class="text-muted">/unit</span>
                  </div>
                  <div class="pp-bulk-row pp-bulk-row--deep">
                    <span>21-100 units</span><strong>NGN 280,000</strong><span class="text-muted">/unit</span>
                  </div>
                  <div class="pp-bulk-row pp-bulk-row--gold">
                    <span>100+ units</span><strong>NGN 250,000</strong><span class="text-muted">/unit</span>
                  </div>
                </div>
                <p class="text-muted">Tell us your quantity and we'll lock in the best rate.</p>
              </div>
            </div>
            {% endif %}
            {% endwith %}

            <div class="pp-detail__actions">
              <button class="pp-btn pp-btn--primary pp-detail__cta-main" type="button" data-add-to-cart
                data-product-id="{{ product.id }}">
                {% if product.stock_quantity > 0 %}Add to cart{% else %}Pre-order now{% endif %}
              </button>
              <button class="pp-btn pp-btn--secondary pp-detail__cta-side" type="button" data-wishlist-toggle
                data-product-id="{{ product.id }}">
                <i class="fa-regular fa-heart" aria-hidden="true"></i>
                <span class="sr-only">Add to wishlist</span>
              </button>
              <button class="pp-btn pp-btn--secondary pp-detail__cta-side" type="button">Install</button>
            </div>

            <div class="pp-detail__tags">
              <span class="pp-pill">Fingerprint</span>
              <span class="pp-pill">NFC</span>
              <span class="pp-pill">App Control</span>
            </div>
          </div>
        </section>
      </div>
    </div>
  </section>

  <section class="section pp-detail__tabs-section">
    <div class="container">
      <nav class="pp-detail__tablist">
        <a href="#overview" class="pp-tab">Overview</a>
        <a href="#features" class="pp-tab is-active">Key Features</a>
        <a href="#specs" class="pp-tab">Specs</a>
        <a href="#box" class="pp-tab">What's in the box</a>
        <a href="#support" class="pp-tab">Installation</a>
        <a href="#reviews" class="pp-tab">Reviews</a>
      </nav>

      <div class="pp-detail__content">
        <div class="stack">
          <section id="overview" class="pp-card">
            <h2>Overview</h2>
            <p class="text-muted">{{ product.description|default:"Premium biometric access control built for modern smart homes." }}</p>
          </section>

          <section id="features" class="pp-card">
            <h2>Key Features</h2>
            <ul class="stack pp-detail__feature-list">
              <li>Fingerprint + palm recognition</li>
              <li>PIN + RFID + NFC access</li>
              <li>Secure smartphone app control</li>
              <li>Auto-lock + anti-spoof tech</li>
              <li>Alexa and Google Assistant ready</li>
            </ul>
          </section>
        </div>

        <aside class="stack">
          <div class="pp-card pp-detail__specs" id="specs">
            <h3>Specs</h3>
            <div class="stack">
              <div class="pp-detail__spec-row"><span>Model</span><strong>{{ product.sku|default:"D2Pro" }}</strong></div>
              <div class="pp-detail__spec-row"><span>Dimensions</span><strong>137 x 46mm</strong></div>
              <div class="pp-detail__spec-row"><span>Weight</span><strong>216g</strong></div>
              <div class="pp-detail__spec-row"><span>Connectivity</span><strong>Wi-Fi + App</strong></div>
            </div>
          </div>

          <div class="pp-card pp-detail__reviews" id="reviews">
            <h3>Reviews</h3>
            <div class="stack">
              <div class="pp-detail__review-row">
                <span>5&#9733;</span>
                <div class="pp-detail__bar-track"><div class="pp-detail__bar pp-detail__bar--60"></div></div>
                <span>515</span>
              </div>
              <div class="pp-detail__review-row">
                <span>4&#9733;</span>
                <div class="pp-detail__bar-track"><div class="pp-detail__bar pp-detail__bar--30"></div></div>
                <span>535</span>
              </div>
              <div class="pp-detail__review-row">
                <span>3&#9733;</span>
                <div class="pp-detail__bar-track"><div class="pp-detail__bar pp-detail__bar--10"></div></div>
                <span>333</span>
              </div>
            </div>
          </div>
        </aside>
      </div>
    </div>
  </section>
</div>
{% endblock %}
